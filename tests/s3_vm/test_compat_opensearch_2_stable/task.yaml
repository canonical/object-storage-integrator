# Copyright 2026 Canonical Ltd.
# See LICENSE file for licensing details.

summary: test_compat_opensearch_2_stable
environment:
  TEST_MODULE: test_consumers/test_compat.py
  SUBSTRATE: vm
execute: |
  cd "$SPREAD_PATH/s3"
  sudo tee -a /etc/sysctl.conf > /dev/null <<EOT
  vm.max_map_count=262144
  vm.swappiness=0
  net.ipv4.tcp_retries2=5
  fs.file-max=1048576
  EOT
  sudo sysctl -p
  cat <<EOF > cloudinit-userdata.yaml
  cloudinit-userdata: |
    postruncmd:
      - [ 'echo', 'vm.max_map_count=262144', '>>', '/etc/sysctl.conf' ]
      - [ 'echo', 'vm.swappiness=0', '>>', '/etc/sysctl.conf' ]
      - [ 'echo', 'net.ipv4.tcp_retries2=5', '>>', '/etc/sysctl.conf' ]
      - [ 'echo', 'fs.file-max=1048576', '>>', '/etc/sysctl.conf' ]
      - [ 'sysctl', '-p' ]
  EOF
  juju add-model test-opensearch
  juju model-config --file=./cloudinit-userdata.yaml
  tox run -e integration -- -x "tests/integration/$TEST_MODULE" --model test-opensearch \
                            --charm opensearch \
                            --channel-v0 2/stable
                            --tls